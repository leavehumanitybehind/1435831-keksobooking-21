(()=>{"use strict";window.util={isEnterKeyPress:e=>"Enter"===e,isEscKeyPress:e=>"Escape"===e,createErrorMessage:e=>{const t=document.createElement("div");t.style="z-index: 100; margin:auto; text-align: center; background-color: rgba(0,0,0, 0.4);",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.width="100%",t.style.height="100%",t.style.paddingTop="300px",t.style.fontSize="60px",t.style.fontWeight="bold",t.style.color="white",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}},(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",t="https://21.javascript.pages.academy/keksobooking/",o=(e,t,o,r,n)=>{const i=new XMLHttpRequest;i.responseType="json",i.addEventListener("load",(()=>{200!==i.status?r("Статус ошибки: "+i.status+" "+i.statusText):o(i.response)})),i.addEventListener("error",(()=>{r("Произошла ошибка соединения. Пожалуйста обновите страницу")})),i.addEventListener("timeout",(()=>{r("Запрос не успел выполниться за "+i.timeout+" мс.  Пожалуйста обновите страницу")})),i.timeout=1e4,i.open(e,t),i.send(n||"")};window.backend={load:(t,r)=>o("GET",e,t,r),upload:(e,r,n)=>o("POST",t,e,r,n)}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&clearTimeout(t),t=setTimeout((()=>{e(...o)}),500)}},(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector(".map"),o=document.querySelector("#address"),r=()=>({x:e.offsetLeft+Math.floor(32.5),y:e.offsetTop+87}),n=()=>{const e=r();o.value=e.x+","+e.y};e.addEventListener("mousedown",(o=>{o.preventDefault();let i={x:o.clientX,y:o.clientY};const s=o=>{o.preventDefault();const s=i.x-o.clientX,d=i.y-o.clientY;i={x:o.clientX,y:o.clientY};const c=r();c.y-d>=130&&c.y-d<=630&&(e.style.top=e.offsetTop-d+"px"),c.x-s>=0&&c.x-s<=t.offsetWidth&&(e.style.left=e.offsetLeft-s+"px"),n()},d=e=>{e.preventDefault(),document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",d)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",d)})),window.move={getCoords:r,getDefaultCoords:()=>{const e=570+Math.floor(32.5);o.value=e+",440"},setDefaultPosition:()=>{e.style.left="570px",e.style.top="375px"},address:n}})(),(()=>{const e="2px dashed #ff0000",t=document.querySelector(".ad-form"),o=document.querySelector("#room_number"),r=document.querySelector("#capacity"),n=t.querySelector("#type"),i=t.querySelector("#price"),s=t.querySelector("#timein"),d=t.querySelector("#timeout"),c=t.querySelectorAll("input");let a=o.value,l=r.value;const u={1:"1 комната - для 1 гостя",2:" 2 комнаты  - для 2 гостей или 1 гостя",3:"3 комнаты  - для 3 гостей, 2 гостей или 1 гостя",100:"100 комнат не для гостей "},m={bungalow:0,flat:1e3,house:5e3,palace:1e4},p=()=>{i.min=m[n.value],i.placeholder=m[n.value];const e=m[t.type.value];t.price.setAttribute("min",e)},y=()=>{i.value>1e6?i.setCustomValidity("Максимальная цена 1000000"):i.setCustomValidity("")},v=(e,t)=>{e.value=t},f=e=>{v(d,e.target.value)},w=e=>{v(s,e.target.value)},h=(e,t)=>{t>e&&100!==e||100!==e&&0===t||100===e&&0!==t?r.setCustomValidity(u[e]):(r.setCustomValidity(""),r.removeEventListener("invalid",h),r.style.border="")};o.addEventListener("change",(()=>{a=o.value,h(a,l)})),r.addEventListener("change",(()=>{l=r.value,r.setCustomValidity(""),h(a,l)})),r.addEventListener("invalid",(()=>{r.style.border=e})),window.validation={change:()=>{n.addEventListener("change",p),i.addEventListener("change",y),s.addEventListener("change",f),d.addEventListener("change",w)},remove:()=>{n.removeEventListener("change",p),i.removeEventListener("change",y),s.removeEventListener("change",f),d.removeEventListener("change",w)},onInputCheck:()=>{c.forEach((o=>{t.checkValidity(),o.addEventListener("invalid",(()=>{o.style.border=e})),o.style.border=""}))}}})(),(()=>{const e={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},t=document.querySelector(".map__pins"),o=document.querySelector("#card").content.querySelector(".map__card"),r={ZERO_ROOM:0,ONE_ROOM:1,FIVE_ROOMS:5},n=()=>{const e=t.querySelector(".map__card");e&&(t.removeChild(e),e.removeEventListener("click",n))},i=()=>{n()},s=e=>{window.util.isEscKeyPress(e.key)&&n(),document.removeEventListener("keydown",s)};window.card={render:t=>{const n=o.cloneNode(!0),{offer:{title:d,address:c,price:a,type:l,guests:u,rooms:m,checkin:p,checkout:y,description:v,photos:f,features:w},author:{avatar:h}}=t;return"title"in t.offer&&(n.querySelector(".popup__title").textContent=d),"address"in t.offer&&(n.querySelector(".popup__text--address").textContent=c),"price"in t.offer&&(n.querySelector(".popup__text--price").textContent=a+" ₽/ночь"),"type"in t.offer&&(n.querySelector(".popup__type").textContent=e[l]),"rooms"in t.offer&&"guests"in t.offer&&(m>r.ONE_ROOM&&m<r.FIVE_ROOMS&&u>=0&&(n.querySelector(".popup__text--capacity").textContent=m+" комнаты для "+u+" гостей"),m===r.ONE_ROOM&&1===u&&(n.querySelector(".popup__text--capacity").textContent=m+" комната для "+u+" гостя"),(m===r.ZERO_ROOM||m>=r.FIVE_ROOM||u>=0)&&(n.querySelector(".popup__text--capacity").textContent=m+" комнат для "+u+" гостей")),"checkin"in t.offer&&"checkout"in t.offer&&(n.querySelector(".popup__text--time").textContent="Заезд после "+p+" выезд до "+y),"description"in t.offer&&(n.querySelector(".popup__description").textContent=v),f&&((e,t)=>{const o=t.querySelector(".popup__photos");o.innerHTML="",e.forEach((function(e){o.appendChild((e=>{const t=document.createElement("img");return t.classList.add("popup__photo"),t.src=e,t.alt="Photo",t.width=45,t.height=40,t})(e))}))})(f,n),w&&((e,t)=>{const o=t.querySelector(".popup__features");o.innerHTML="";const r=(e=>{const t=document.createDocumentFragment();return e.offer.features.forEach((e=>{const o=document.createElement("li");o.classList.add("popup__feature"),o.classList.add("popup__feature--"+e),t.appendChild(o)})),t})(e);o.appendChild(r)})(t,n),"avatar"in t.author&&(n.querySelector(".popup__avatar").src=h),n.querySelector(".popup__close").addEventListener("click",i),document.addEventListener("keydown",s),n},disable:n}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins");let o=[];const r={WIDTH:50,HEIGHT:70},n=t=>{const{offer:{title:o},author:{avatar:n},location:{x:i,y:s}}=t,d=e.cloneNode(!0);d.querySelector("img").src=n,d.querySelector("img").alt=o;const c=i-r.WIDTH/2,a=s-r.HEIGHT;return d.style.left=c+"px",d.style.top=a+"px",d},i=(e,o)=>{e.addEventListener("click",(()=>{const r=t.querySelector(".map__pin--active");r&&(r.classList.remove("map__pin--active"),window.card.disable()),e.classList.add("map__pin--active"),t.appendChild(window.card.render(o))}))};window.pin={Size:r,render:e=>{const r=document.createDocumentFragment();o=e;const s=o.length>5?5:o.length;for(let e=0;e<s;e++){const t=n(o[e]);r.append(t),i(t,o[e])}t.appendChild(r)},remove:()=>{t.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{t.removeChild(e)}))},activate:i,ads:o}})(),(()=>{const e=document.querySelector(".map__filters"),t=document.querySelector("#housing-type"),o=document.querySelector("#housing-price"),r=document.querySelector("#housing-rooms"),n=document.querySelector("#housing-guests"),i=document.querySelector("#housing-features"),s="any",d="type",c="rooms",a="guests",l=(e,t,o)=>e.value===s||e.value===o[t].toString(),u=e=>l(t,d,e.offer)&&l(r,c,e.offer)&&l(n,a,e.offer)&&(e=>{const t=i.querySelectorAll("input:checked");return Array.from(t).every((t=>e.includes(t.value)))})(e.offer.features)&&((e,t)=>{switch(o.value){case s:return!0;case"low":return t<1e4;case"middle":return t>=1e4&&t<=5e4;case"high":return t>5e4}return!1})(0,e.offer.price),m=()=>{e.addEventListener("change",p)},p=window.debounce((()=>{m(),window.card.disable(),window.pin.remove(),(e=>{const t=e.filter(u);window.pin.render(t)})(window.pin.ads)}));window.filter={remove:()=>{e.removeEventListener("change",p)},change:m}})(),(()=>{const e=document.querySelector(".ad-form"),t=document.querySelector("#success").content,o=document.querySelector("#error").content,r=document.querySelector("main"),n=document.querySelector(".map__filters"),i=n.querySelectorAll("select"),s=e.querySelectorAll("select"),d=e.querySelectorAll(".fieldset"),c=e.querySelectorAll("input"),a=document.querySelector("#housing-features").querySelectorAll("input[type=checkbox]"),l=e.querySelectorAll(".feature__checkbox"),u=e.querySelector(".ad-form__reset"),m=e.querySelector(".ad-form__submit"),p=e.querySelector("textarea"),y=document.querySelector("#capacity"),v=e=>{e.forEach((e=>{e.checked&&(e.checked=!1)}))},f=e=>{e.forEach((e=>{e.setAttribute("disabled","disabled")})),n.setAttribute("disabled","disabled")},w=e=>{e.forEach((e=>{e.removeAttribute("disabled","disabled")})),n.removeAttribute("disabled","disabled")},h=()=>{r.removeChild(r.querySelector(".error")),document.removeEventListener("keydown",_),document.removeEventListener("click",h)},_=e=>{window.util.isEscKeyPress(e)&&h()},E=e=>{window.util.isEscKeyPress(e)&&g()},b=()=>{h()},S=()=>{g()},g=()=>{r.removeChild(r.querySelector(".success")),document.removeEventListener("keydown",E),document.removeEventListener("click",S)};window.form={enable:()=>{w(d),w(c),w(s),w(i),e.removeAttribute("disabled","disabled"),m.removeAttribute("disabled","disabled"),u.removeAttribute("disabled","disabled"),p.removeAttribute("disabled","disabled")},disable:()=>{f(d),f(c),f(s),f(i),e.setAttribute("disabled","disabled"),m.setAttribute("disabled","disabled"),u.setAttribute("disabled","disabled"),p.setAttribute("disabled","disabled")},reset:()=>{e.reset(),y.style.border="",v(l)},resetFilters:()=>{n.querySelectorAll("select").forEach((e=>(e.value="any",e))),v(a)},success:()=>{const e=t.cloneNode(!0);e.querySelector(".success").addEventListener("click",S),r.appendChild(e)},error:()=>{const e=o.cloneNode(!0);e.querySelector(".error").addEventListener("click",b),r.appendChild(e)}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form__field input[type=file]"),o=document.querySelector(".ad-form-header__preview img"),r=document.querySelector(".ad-form__upload input[type=file]"),n=document.querySelector(".ad-form__photo img"),i=(t,o)=>{const r=t.files[0],n=r.name.toLowerCase(),i=e.some((e=>n.endsWith(e))),s=new FileReader;s.addEventListener("load",(()=>{o.src=s.result,o.setAttribute("width","100%"),o.setAttribute("height","100%")})),t.setCustomValidity(""),i||t.setCustomValidity("Недопустимый формат изображения"),s.readAsDataURL(r)},s=e=>{e.src="img/muffin-grey.svg",e.setAttribute("width","40px"),e.setAttribute("height","44px")},d=()=>{i(t,o)},c=()=>{i(r,n)};window.photo={reset:()=>{s(o),s(n)},removeListeners:()=>{t.removeEventListener("change",d),r.removeEventListener("change",c)},addListeners:()=>{r.addEventListener("change",c),t.addEventListener("change",d)}}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector(".map"),o=document.querySelector(".map__filters"),r=document.querySelector(".ad-form"),n=r.querySelector(".ad-form__reset"),i=r.querySelector(".ad-form__submit"),s=e=>{window.pin.ads=e,window.pin.render(window.pin.ads)},d=e=>{window.util.createErrorMessage(e)},c=e=>{e.preventDefault(),l()},a=()=>{t.classList.remove("map--faded"),o.classList.remove("map__filters--disabled"),r.classList.remove("ad-form--disabled"),m(),window.filter.change(),window.form.enable(),window.move.address(window.move.getCoords),window.backend.load(s,d)},l=()=>{t.classList.add("map--faded"),window.form.disable(),window.pin.remove(),window.form.reset(),window.form.resetFilters(),window.card.disable(),window.filter.remove(),window.photo.reset(),p(),e.addEventListener("mousedown",y),e.addEventListener("keydown",v),o.classList.add("map__filters--disabled"),r.classList.add("ad-form--disabled"),window.move.getDefaultCoords(),window.move.setDefaultPosition()},u=e=>{e.preventDefault(),window.backend.upload(window.form.success,window.form.error,new FormData(r)),l()},m=()=>{window.validation.change(),window.photo.addListeners(),r.addEventListener("submit",u),i.addEventListener("click",window.validation.onInputCheck),n.addEventListener("click",c)},p=()=>{window.validation.remove(),window.photo.removeListeners(),r.removeEventListener("submit",u),n.removeEventListener("click",c),i.removeEventListener("click",window.validation.onInputCheck)},y=t=>{1===t.which&&a(),e.removeEventListener("mousedown",y)},v=t=>{window.util.isEnterKeyPress(t.key)&&a(),e.removeEventListener("keydown",v)};l()})()})();