(()=>{"use strict";window.util={isEnterKeyPress:function(e){return"Enter"===e},isEscKeyPress:function(e){return"Escape"===e},createErrorMessage:function(e){const t=document.createElement("div");t.style="z-index: 100; margin:auto; text-align: center; background-color: rgba(0,0,0, 0.4);",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.width="100%",t.style.height="100%",t.style.paddingTop="300px",t.style.fontSize="60px",t.style.fontWeight="bold",t.style.color="white",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}},(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",t="https://21.javascript.pages.academy/keksobooking/",n=function(e,t){const n=new XMLHttpRequest;return n.responseType="json",n.addEventListener("load",(function(){200!==n.status?t("Статус ошибки: "+n.status+" "+n.statusText):e(n.response)})),n.addEventListener("error",(function(){t("Произошла ошибка соединения. Пожалуйста обновите страницу")})),n.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+n.timeout+" мс.  Пожалуйста обновите страницу")})),n.timeout=1e4,n};window.backend={load:function(t,o){const r=n(t,o);r.open("GET",e),r.send()},upload:function(e,o,r){const i=n(e,o);i.open("POST",t),i.send(r)}}})(),window.debounce=function(e){let t=null;return function(n){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(null,n)}),500)}},(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector(".map"),n=document.querySelector("#address"),o=function(){return{x:e.offsetLeft+Math.floor(32.5),y:e.offsetTop+87}},r=function(){const e=o();n.value=e.x+","+e.y};e.addEventListener("mousedown",(function(n){n.preventDefault();let i={x:n.clientX,y:n.clientY};const c=function(n){n.preventDefault();const c=i.x-n.clientX,u=i.y-n.clientY;i={x:n.clientX,y:n.clientY};const s=o();s.y-u>=130&&s.y-u<=630&&(e.style.top=e.offsetTop-u+" px"),s.x-c>=0&&s.x-c<=t.offsetWidth&&(e.style.left=e.offsetLeft-c+" px"),r()},u=function(e){e.preventDefault(),document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",u)};document.addEventListener("mousemove",c),document.addEventListener("mouseup",u)})),window.move={getCoords:o,defaultCoords:function(){const t=570+Math.floor(32.5);e.style.left="570 px",e.style.top="375 px",n.value=t+",440"},address:r}})(),(()=>{const e=document.querySelector(".ad-form"),t=document.querySelector("#room_number"),n=document.querySelector("#capacity"),o=e.querySelector("#type"),r=e.querySelector("#price"),i=e.querySelector("#timein"),c=e.querySelector("#timeout");let u=t.value,s=n.value;const d=e.querySelectorAll("input"),a={1:"1 комната - для 1 гостя",2:" 2 комнаты  - для 2 гостей или 1 гостя",3:"3 комнаты  - для 3 гостей, 2 гостей или 1 гостя",100:"100 комнат не для гостей "},l={bungalow:0,flat:1e3,house:5e3,palace:1e4},f=function(){r.min=l[o.value],r.placeholder=l[o.value];let t=l[e.type.value];e.price.setAttribute("min",t)},m=function(){if(r.value>1e6)return r.setCustomValidity("Максимальная цена 1000000"),void r.classList.add("invalid");r.setCustomValidity(""),r.classList.remove("invalid")},p=function(e,t){e.value=t},y=function(e){p(c,e.target.value)},v=function(e){p(i,e.target.value)},w=function(e){e.style.border="2px dashed #ff0000"},h=function(e){e.style.border=""},_=function(e,t){return t>e&&100!==e||100!==e&&0===t||100===e&&t>0?(n.setCustomValidity(a[e]),void w(n)):(n.setCustomValidity(""),void h(n))};t.addEventListener("change",(function(){u=t.value,_(u,s)})),n.addEventListener("change",(function(){s=n.value,n.setCustomValidity(""),_(u,s)})),window.validation={change:function(){o.addEventListener("change",f),r.addEventListener("change",m),i.addEventListener("change",y),c.addEventListener("change",v)},remove:function(){o.removeEventListener("change",f),r.removeEventListener("change",m),i.removeEventListener("change",y),c.removeEventListener("change",v)},check:function(){d.forEach((function(e){e.checkValidity()?e.style.border="":e.style.border="2px dashed #ff0000"}))},setError:w,clearError:h}})(),(()=>{const e={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},t=document.querySelector(".map__pins"),n=document.querySelector("#card").content.querySelector(".map__card"),o=function(){const e=t.querySelector(".map__card");e&&(t.removeChild(e),e.removeEventListener("click",o))},r=function(e){window.util.isEscKeyPress(e.key)&&o(),document.removeEventListener("keydown",r)};window.card={render:function(t){const i=n.cloneNode(!0),{offer:{title:c,address:u,price:s,type:d,guests:a,rooms:l,checkin:f,checkout:m,description:p,photos:y,features:v},author:{avatar:w}}=t;return c&&(i.querySelector(".popup__title").textContent=c),u&&(i.querySelector(".popup__text--address").textContent=u),s&&(i.querySelector(".popup__text--price").textContent=s+" ₽/ночь"),d&&(i.querySelector(".popup__type").textContent=e[d]),l&&a&&(l>1&&l<5&&a>1&&(i.querySelector(".popup__text--capacity").textContent=l+" комнаты для "+a+" гостей"),1===l&&1===a&&(i.querySelector(".popup__text--capacity").textContent=l+" комната для "+a+" гостя"),l>=5&&(i.querySelector(".popup__text--capacity").textContent=l+" комнат для "+a+" гостей")),f&&m&&(i.querySelector(".popup__text--time").textContent="Заезд после "+f+" выезд до "+m),p&&(i.querySelector(".popup__description").textContent=p),w&&(i.querySelector(".popup__avatar").src=w),y&&function(e,t){const n=t.querySelector(".popup__photos");n.innerHTML="",e.forEach((function(e){n.appendChild(function(e){const t=document.createElement("img");return t.classList.add("popup__photo"),t.src=""+e,t.alt="Photo",t.width="45",t.height="40",t}(e))}))}(y,i),v&&function(e,t){const n=t.querySelector(".popup__features");n.innerHTML="";const o=function(e){const t=document.createDocumentFragment();for(let n=0;n<e.offer.features.length;n++){const o=document.createElement("li");o.classList.add("popup__feature"),o.classList.add("popup__feature--"+e.offer.features[n]),t.appendChild(o)}return t}(e);n.appendChild(o)}(t,i),i.querySelector(".popup__close").addEventListener("click",o),document.addEventListener("keydown",r),i},disable:o}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins"),n={WIDTH:50,HEIGHT:70};window.pin={Size:n,render:function(t){const{offer:{title:o},author:{avatar:r},location:{x:i,y:c}}=t,u=e.cloneNode(!0);u.querySelector("img").src=r,u.querySelector("img").alt=o;const s=i-n.WIDTH/2,d=c-n.HEIGHT;return u.style="left:"+s+"px; top:"+d+"px;",u},remove:function(){t.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((function(e){t.removeChild(e)}))},activate:function(e,n){e.addEventListener("click",(function(){const o=t.querySelector(".map__pin--active");o&&(o.classList.remove("map__pin--active"),window.card.disable()),e.classList.add("map__pin--active"),t.appendChild(window.card.render(n))}))}}})(),(()=>{const e=document.querySelector(".map__filters"),t=document.querySelector(".map__pins"),n=document.querySelector("#housing-type"),o=document.querySelector("#housing-price"),r=document.querySelector("#housing-rooms"),i=document.querySelector("#housing-guests"),c=document.querySelector("#housing-features");let u=[];const s="any",d="type",a="rooms",l="guests",f=function(e,t,n){return e.value===s||e.value===n.offer[t].toString()},m=function(e){return f(n,d,e)&&f(r,a,e)&&f(i,l,e)&&function(e){const t=c.querySelectorAll("input:checked");return Array.from(t).every((function(t){return e.offer.features.includes(t.value)}))}(e)&&function(e,t){switch(o.value){case s:return!0;case"low":return t<1e4;case"middle":return t>=1e4&&t<=5e4;case"high":return t>5e4}return!1}(0,e.offer.price)},p=function(e){const n=(e=u.filter(m).slice(0,5)).length>5?5:e.length;for(let o=0;o<n;o++){const n=window.pin.render(e[o]);t.appendChild(n),window.pin.activate(n,e[o])}},y=function(){e.addEventListener("change",v)},v=function(){y(),window.card.disable(),window.pin.remove(),window.debounce(p(u))};window.filter={remove:function(){e.removeEventListener("change",v)},change:y,error:function(e){window.util.createErrorMessage(e)},success:function(e){u=e,p(u)}}})(),(()=>{const e=document.querySelector(".ad-form"),t=document.querySelector("#success").content,n=document.querySelector("#error").content,o=document.querySelector("main"),r=document.querySelector(".map__filters"),i=r.querySelectorAll("select"),c=e.querySelectorAll("select"),u=e.querySelectorAll(".fieldset"),s=e.querySelectorAll("input"),d=document.querySelector("#housing-features").querySelectorAll("input[type=checkbox]"),a=e.querySelectorAll(".feature__checkbox"),l=e.querySelector(".ad-form__reset"),f=e.querySelector(".ad-form__submit"),m=e.querySelector("textarea"),p=function(e){e.forEach((function(e){e.checked&&(e.checked=!1)}))},y=function(e){e.forEach((function(e){e.setAttribute("disabled","disabled")})),r.setAttribute("disabled","disabled")},v=function(e){e.forEach((function(e){e.removeAttribute("disabled","disabled")})),r.removeAttribute("disabled","disabled")},w=function(){o.removeChild(o.querySelector(".error")),document.removeEventListener("keydown",h),document.removeEventListener("click",w)},h=function(e){window.util.isEscKeyPress(e)&&w()},_=function(e){window.util.isEscKeyPress(e)&&q()},b=function(){q()},S=function(){q()},q=function(){o.removeChild(o.querySelector(".success")),document.removeEventListener("keydown",_),document.removeEventListener("click",S)};window.form={enable:function(){v(u),v(s),v(c),v(i),e.removeAttribute("disabled","disabled"),f.removeAttribute("disabled","disabled"),l.removeAttribute("disabled","disabled"),m.removeAttribute("disabled","disabled")},disable:function(){y(u),y(s),y(c),y(i),e.setAttribute("disabled","disabled"),f.setAttribute("disabled","disabled"),l.setAttribute("disabled","disabled"),m.setAttribute("disabled","disabled")},reset:function(){e.reset(),p(a)},resetFilters:function(){r.querySelectorAll("select").forEach((function(e){return e.value="any",e})),p(d)},success:function(){const e=t.cloneNode(!0);e.querySelector(".success").addEventListener("click",b),o.appendChild(e)},error:function(){const e=n.cloneNode(!0);e.querySelector(".error").addEventListener("click",w),o.appendChild(e)}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form__field input[type=file]"),n=document.querySelector(".ad-form-header__preview img"),o=document.querySelector(".ad-form__upload input[type=file]"),r=document.querySelector(".ad-form__photo img"),i=function(t,n){const o=t.files[0],r=o.name.toLowerCase(),i=e.some((function(e){return r.endsWith(e)})),c=new FileReader;c.addEventListener("load",(function(){n.src=c.result,n.setAttribute("width","100%"),n.setAttribute("height","100%")})),t.setCustomValidity(""),i||(t.setCustomValidity("Недопустимый формат изображения"),window.validation.setError(t)),c.readAsDataURL(o),window.validation.clearError(t)},c=function(e){e.src="img/muffin-grey.svg",e.setAttribute("width","40px"),e.setAttribute("height","44px")},u=function(){i(t,n)},s=function(){i(o,r)};window.photo={reset:function(){c(n),c(r)},remove:function(){t.removeEventListener("change",u),o.removeEventListener("change",s)},add:function(){o.addEventListener("change",s),t.addEventListener("change",u)}}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector(".map"),n=document.querySelector(".map__filters"),o=document.querySelector(".ad-form"),r=o.querySelector(".ad-form__reset"),i=function(){r.addEventListener("click",(function(e){e.preventDefault(),u()}))},c=function(){t.classList.remove("map--faded"),n.classList.remove("map__filters--disabled"),o.classList.remove("ad-form--disabled"),d(),window.filter.change(),window.form.enable(),window.move.address(window.move.getCoords),window.backend.load(window.filter.success,window.filter.error)},u=function(){t.classList.add("map--faded"),window.form.disable(),window.pin.remove(),window.form.reset(),window.form.resetFilters(),window.card.disable(),window.move.defaultCoords(),window.filter.remove(),window.photo.reset(),a(),i(),e.addEventListener("mousedown",l),e.addEventListener("keydown",f),n.classList.add("map__filters--disabled"),o.classList.add("ad-form--disabled")},s=function(e){e.preventDefault(),window.backend.upload(window.form.success,window.form.error,new FormData(o)),u()},d=function(){window.validation.change(),window.photo.add(),o.addEventListener("change",window.validation.check),o.addEventListener("submit",s)},a=function(){window.validation.remove(),window.photo.remove(),o.removeEventListener("submit",s),r.removeEventListener("click",i)},l=function(t){1===t.which&&c(),e.removeEventListener("mousedown",l)},f=function(t){window.util.isEnterKeyPress(t.key)&&c(),e.removeEventListener("keydown",f)};u()})()})();